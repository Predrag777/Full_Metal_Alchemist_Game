<html>
    <head>
        <title>Full Metal</title>
        <link rel="stylesheet" href="style/main_style.css">
    </head>
    <body id="body">
        <div id="myInfo" style="float: left; ">
            <h1 id="myHelth">100</h2>
            <h1 id="myKi">100</h2>
        </div>
        
        <div id="enemyInfo" style="float:right; display: inline-block; color: red;">
            <h1 id="enemyHelth">100</h2>
            <h1 id="enemyKi">100</h2>
        </div>
        
        <div id="main_player"></div>
    </body>
    <script>
        let csvContent = "data:text/csv;charset=utf-8,"; 

csvContent += "Step,X,Y,Action\n";

function addMovementToCSV(step, x, y, xx, yy, action) {
    csvContent += `${step},${x},${y},${xx},${yy},${action}\n`;
}

function downloadCSV(filename) {
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", filename);
    document.body.appendChild(link);

    link.click();
        document.body.removeChild(link); 
    }

    let stepCounter = 1;
    function logEnemyMove(x, y, xx,yy, action) {
        addMovementToCSV(stepCounter, x, y, xx,yy, action);
        stepCounter++;
    }

    function saveEnemyMovements() {
        downloadCSV("enemy_movements.csv");
    }

    </script>

    <script>
   async function getAIAnswer(arg1, arg2, arg3, arg4) {
    try {
        const url = `http://localhost:5000/api/receive?arg1=${arg1}&arg2=${arg2}&arg3=${arg3}&arg4=${arg4}`;

        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();

        return data.message;  
    } catch (error) {
        console.error('Error:', error);
    }
}


    </script>

    <script>
        class Enemy {
            constructor(id, x, y) {
                this.x = x;
                this.y = y;
                this.id = id;
                this.move = false;
                this.jump = false;
                this.attack = false;
            }

            startMove() {
                this.move = true;
            }

            stopMove() {
                this.move = false;
            }

            startJump() {
                this.jump = true;
            }

            stopJump() {
                this.jump = false;
            }

            startAttack() {
                this.attack = true;
            }

            stopAttack() {
                this.attack = false;
            }
        }
        var enemyUrl='url("images/characters/mustang/roymustangBase.png")'
        function createEnemy(id, x, y) {
            const enemy = document.createElement("div");
            enemy.id = `enemy-${id}`;
            enemy.style.backgroundRepeat="no-repeat"
            enemy.style.backgroundImage=enemyUrl;
            enemy.style.width = "200px"; 
            enemy.style.height = "250px"; 
            enemy.style.position = "absolute"; 
            enemy.style.left = x + "px"; 
            enemy.style.top = y + "px"; 
            enemy.style.transform = "scaleX(-1)";
            enemy.classList.add("enemy");
            document.getElementById("body").appendChild(enemy);
        }

        function updateEnemyPosition(id, x, y) {
            const enemy = document.getElementById(`enemy-${id}`);
            if (enemy) {
                enemy.style.left = x + "px";
                enemy.style.top = y + "px";
            }
        }

        var x = 200;
        var y = 700;
        var speed = 0, jumpSpeed = 0, myCounter = 0;
        var jump = false, reachedTop = false, weapon1 = false, move = false, kick=false, attack=false, punched=true;
        var alchemyAttack=false, power=false
        var alchemyX=0, alchemyY=700

        var enemySpeed = 20, enemyJumpSpeed = 40, enemyCounter=0;
        var enemyJump = false, enemyReachTop = false;
        var enemyAttack=false, enemyKick=false , enemyPunched=false

        //Setup helth
        var myHelth=100, myKi=100
        var enemyHelth=100, enemyKi=100

        var numberOfEnemy = 1;
        var enemiesList = [];

        for (let i = 0; i < numberOfEnemy; i++) {
            const newEnemy = new Enemy(i, 800 + i * 200, 700);
            createEnemy(i, newEnemy.x, newEnemy.y);
            enemiesList.push(newEnemy);
        }

        var urlImage = 'url("images/characters/edward/edwardelricBase.png")';

        function setPlayer(x, y) {
            var div = document.getElementById("main_player");
            div.style.marginLeft = x + "px";
            div.style.marginTop = y + "px";
            div.style.backgroundImage = urlImage;
        }

        document.addEventListener('keydown', function (event) {
            if (event.key === 'ArrowUp' && !jump) {
                jump = true;
                jumpSpeed = 50;
            }
            if (event.key === 'ArrowRight') {
                move = true;
                speed = 20;
            }
            if (event.key === 'ArrowLeft') {
                move = true;
                speed = -20;
            }
            if (event.key === "1" && !jump) {
                weapon1 = true;
            }
            if(event.key ==="a"){
                attack=true
            }
            if(event.key==="d"){
                kick=true
            }
            if(event.key === "s" && !jump){
                alchemyAttack=true
            }
            if (event.key === 'Enter') {
                saveEnemyMovements(); 
            }
        });

        function handleMovement() {
            if (move) {
                x += speed;
                urlImage = (urlImage.includes('edwardelricBase.png')) 
                    ? 'url("images/characters/edward/edwardelricBase2.png")' 
                    : 'url("images/characters/edward/edwardelricBase.png")';
                move = false;
                speed = 0;
            }
        }

        function handleAlchemyAttack(){
            
            if(myCounter<10){
                urlImage = 'url("images/characters/edward/edwardelricSpecAttack.png")';
            }else if(myCounter<20){
                alchemyX=enemiesList[0].x
                urlImage = 'url("images/characters/edward/edwardelricSpecAttack1.png")';
            }else if(myCounter<40){
                var alchemyDiv=document.createElement("div")
                alchemyDiv.id="alchemy"
                alchemyDiv.style.width="400px"
                alchemyDiv.style.height="100px"
                alchemyDiv.style.top="800px"
                alchemyDiv.style.left=alchemyX+"px"
                alchemyDiv.style.backgroundImage="url('images/characters/edward/edwardelricPower.png')"
                
                if(myCounter==21)
                    document.getElementById("body").appendChild(alchemyDiv);
                if(myCounter==38){
                    document.getElementById("alchemy").remove()
                }
                power=true
                urlImage = 'url("images/characters/edward/edwardelricSpecAttack2.png")';
            }else{
                power=false
                alchemyAttack=false
                myCounter=-1
                urlImage='url("images/characters/edward/edwardelricBase2.png")' 
            }
            myCounter++
        }

        function handleJump() {
            if (jump) {
                y -= jumpSpeed;
                if (y < 500 && !reachedTop) {
                    jumpSpeed *= -1;
                    reachedTop = true;
                }
                if (reachedTop && y >= 700) {
                    y = 700;
                    jumpSpeed = 0;
                    jump = false;
                    reachedTop = false;
                    urlImage = 'url("images/characters/edward/edwardelricBase.png")';
                } else {
                    urlImage = 'url("images/characters/edward/edwardelricJump.png")';
                }
            }
        }

        function handleWeapon1() {
            if (weapon1) {
                myCounter++;
                if (myCounter < 15) {
                    urlImage = 'url("images/characters/edward/edwardelricCallWeapon.png")';
                } else if (myCounter < 20) {
                    urlImage = 'url("images/characters/edward/edwardelricWeapon1.png")';
                    weapon1 = false;
                } else {
                    myCounter = 0;
                    weapon1 = false;
                }
            }
        }

        function handleAttack(){
            if(attack){
                if(myCounter<5){
                    urlImage = 'url("images/characters/edward/edwardelricPunch2.png")';
                }else if(myCounter<10){
                    if(enemiesList[0].x-x<200){
                        enemyPunched=true
                        enemyHelth-=10
                    }
                    urlImage = 'url("images/characters/edward/edwardelricPunch.png")';
                }else{
                    myCounter=-1
                    attack=false
                    urlImage = 'url("images/characters/edward/edwardelricBase.png")';
                }
                myCounter++
            }
            if(kick){
                if(myCounter<10){
                    urlImage = 'url("images/characters/edward/edwardelricKick1.png")';
                }else if(myCounter<15){
                    if(enemiesList[0].x-x<200 && myCounter==13){
                        enemyPunched=true
                        
                        enemyHelth-=15
                    }
                    urlImage = 'url("images/characters/edward/edwardelricMidKick.png")';
                }else{
                    myCounter=-1
                    kick=false
                    urlImage = 'url("images/characters/edward/edwardelricBase.png")';
                }
                myCounter++
            }
            
        }

        function handlePunched(){
            if(punched){
                if(myCounter<5){
                    if(myCounter==1)
                        myHelth-=10
                    urlImage = 'url("images/characters/edward/edwardelricPunched.png")';
                    x-=5
                }else{
                    urlImage = 'url("images/characters/edward/edwardelricBase.png")';
                    myCounter=-1
                    punched=false
                }
                myCounter++
            }
        }
        function enemiesPunched(id){
            if(enemyPunched){
                if(enemyCounter<5){
                    enemyUrl='url("images/characters/mustang/royPunched.png")' 
                    enemiesList[id].x+=10
                }else{
                    console.log("WAFFEN")
                    enemyCounter=-1
                    enemyPunched=false
                    enemyUrl='url("images/characters/mustang/roymustangBase.png")' 
                }
                updateEnemyPosition(id, enemiesList[id].x, enemiesList[id].y);
                enemyCounter++
            }
        }

        function moveEnemies(id, direction) {

            speed=direction*enemySpeed
            if(enemiesList[id].x-speed>50 ){
                enemyUrl=(enemyUrl.includes('roymustangBase.png')) 
                    ? 'url("images/characters/mustang/roymustangBase2.png")' 
                    : 'url("images/characters/mustang/roymustangBase.png")';
                enemiesList[id].x -= speed;
            }
            
            updateEnemyPosition(id, enemiesList[id].x, enemiesList[id].y);
        }

        function attackEnemy(id){
            if(enemyPunched){
                    enemyAttack=false
                    myCounter=0
                }
            if(enemyAttack){
                
                if(enemyCounter<2){
                    enemyUrl='url("images/characters/mustang/roymustangPunch1.png")' 
                }else if(enemyCounter<4){
                    enemyUrl='url("images/characters/mustang/roymustangPunch2.png")' 
                }else if(enemyCounter<6){
                    enemyUrl='url("images/characters/mustang/roymustangPunch3.png")' 
                }else if(enemyCounter<8){
                    if(enemyCounter==7 && enemiesList[id].x-x<200){
                        punched=true
                        handlePunched()
                    }
                    enemyUrl='url("images/characters/mustang/roymustangPunch4.png")' 
                }else if(enemyCounter<10){
                    enemyUrl='url("images/characters/mustang/roymustangPunch5.png")' 
                }else if(enemyCounter<12){
                    enemyUrl='url("images/characters/mustang/roymustangPunch6.png")' 
                }else{
                    enemyCounter=-1
                    enemyAttack=false
                    enemyUrl='url("images/characters/mustang/roymustangBase.png")'
                }
                enemyCounter++
            }
        }

        function enemyNextMoveMonteCarlo(myX, myY, x, y, jump, enemyJump) {
            const possibleMoves = [1, 2, 3, 4]; 
            const simulations = 100; 
            const maxSteps = 10; 
            const moveScores = {1: 0, 2: 0, 3: 0, 4: 0}; 

            for (let i = 0; i < simulations; i++) {
                const move = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                let simulatedX = x;
                let simulatedY = y;
                let score = 0;

                for (let step = 0; step < maxSteps; step++) {
                    switch (move) {
                        case 1: 
                            simulatedX -= 20;
                            break;
                        case 2: 
                            simulatedX += 20;
                            break;
                        case 3: 
                            simulatedY -= 50; 
                            break;
                        case 4: 
                            if (simulatedX < myX + 200) {
                                score += 50; 
                            }
                            break;
                    }

                    const distanceToPlayer = Math.abs(simulatedX - myX);
                    score -= distanceToPlayer;

                    if (simulatedX < myX + 150) {
                        score += 20; 
                    }
                }

                moveScores[move] += score;
            }
            let bestMove = 1;
            let bestScore = moveScores[1];

            for (let move of possibleMoves) {
                if (moveScores[move] > bestScore) {
                    bestScore = moveScores[move];
                    bestMove = move;
                }
            }

            return bestMove;
    }


    
        function jumpEnemies(id) {
            enemiesList[id].y -= enemyJumpSpeed;
            if (enemiesList[id].y < 500 && !enemyReachTop) {
                enemyJumpSpeed *= -1;
                enemyReachTop = true;
            }
            if (enemyReachTop && enemiesList[id].y>700) {
                enemiesList[id].y = 700;
                enemyJumpSpeed = 0;
                enemyJump = false;
                enemyReachTop = false;
            }
            updateEnemyPosition(id, enemiesList[id].x, enemiesList[id].y);
        }

        window.addEventListener('beforeunload', function (e) {
            saveEnemyMovements();
        });

        
        let enemyMovePending = false; 

var repaint = setInterval(function () {
    if (!enemyMovePending && !enemyAttack && !enemyPunched) {
        enemyMovePending = true; 
        
        getAIAnswer(x, y, enemiesList[0].x, enemiesList[0].y).then(a => {

            switch (a) {
                case 0:
                    moveEnemies(0, 1); 
                    break;
                case 1:
                     moveEnemies(0,-1)
                    break;
                case 2:
                    enemyAttack=true
                    
                
            }
        }).catch(error => {
            console.error('GreÅ¡ka tokom API poziva:', error);
        }).finally(() => {
            enemyMovePending = false; 
        });
    }
    attackEnemy(0)
    enemiesPunched(0)
    
    document.getElementById("enemy-0").style.backgroundImage = enemyUrl;

    if (alchemyAttack)
        handleAlchemyAttack(); 
    handleAttack();  
    handlePunched(); 
    handleMovement(); 
    handleJump(); 
    handleWeapon1(); 

    setPlayer(x, y); 

    for (let i = 0; i < numberOfEnemy; i++) {
        updateEnemyPosition(i, enemiesList[i].x, enemiesList[i].y); 
    }  

    document.getElementById("enemyKi").innerHTML = enemyKi;
    document.getElementById("enemyHelth").innerHTML = enemyHelth;
    document.getElementById("myHelth").innerHTML = myHelth;
    document.getElementById("myKi").innerHTML = myKi;

    if(enemyKi<100)
        enemyKi+=0.01
}, 100);

        setPlayer(x, y);

        
    </script>
</html>
